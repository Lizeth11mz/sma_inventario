{% extends 'core/base.html' %}

{% load static %}

{% load humanize %}

{% block title %}Inventario General y Movimientos{% endblock %}

{% block content %}
Â  Â  <h1 class="header-title">INVENTARIO</h1>

Â  Â  <div class="tab-buttons">
Â  Â  Â  Â  <button id="tab-stock" onclick="showTab('view-stock')" class="active">INVENTARIO</button>
Â  Â  Â  Â  <button id="tab-movimientos" onclick="showTab('view-movimientos')">MOVIMIENTOS</button>
Â  Â  </div>

Â  Â  {# ðŸš€ FORMULARIO DE FILTRO #}
Â  Â  <form method="GET" action="{% url 'inventario:dashboard' %}" class="filter-search-container">
Â  Â  Â  Â 
Â  Â  Â  Â  <div class="filter-controls" style="display: flex; gap: 15px; align-items: center;">
Â  Â  Â  Â  Â  Â  <span class="filter-label" style="font-weight: bold;">Filtro Por:</span>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  {# ðŸ’¡ RADIO BUTTONS PARA FILTRADO DE INVENTARIO (DescripciÃ³n, Clase) #}
Â  Â  Â  Â  Â  Â  <div id="filter-inventario" class="filter-set" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="radio-label">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="filtro_por" value="Descripcion"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% if current_filter == 'Descripcion' or not current_filter %}checked{% endif %}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  DescripciÃ³n (Producto)
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <label class="radio-label">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="filtro_por" value="Clase"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% if current_filter == 'Clase' %}checked{% endif %}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Clase
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  {# ðŸ’¡ RADIO BUTTONS PARA FILTRADO DE MOVIMIENTOS (Elemento y Destino) #}
Â  Â  Â  Â  Â  Â  <div id="filter-movimientos" class="filter-set" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="radio-label">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="filtro_por" value="Elemento"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% if current_filter == 'Elemento' %}checked{% endif %}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Elemento (Producto)
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <label class="radio-label">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="filtro_por" value="Destino"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% if current_filter == 'Destino' %}checked{% endif %}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Destino (Referencia)
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="search-box" style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  <input type="text" name="busqueda" placeholder="BÃºsqueda..."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value="{{ current_search|default:'' }}" style="padding: 8px; border-radius: 4px; border: 1px solid #5a646c; background-color: #34495e; color: white;">
Â  Â  Â  Â  Â  Â  <button type="submit" style="padding: 8px 15px; background-color: #5a646c; color: white; border: none; border-radius: 4px; cursor: pointer;">Buscar</button>
Â  Â  Â  Â  </div>
Â  Â  </form>
Â  Â 
Â  Â 
Â  Â  {# --- TABLA DE INVENTARIO (STOCK) --- #}
Â  Â  <div id="view-stock" class="data-view" style="display: none;">
Â  Â  Â  Â  <h2>Inventario General </h2>
Â  Â  Â  Â  <table class="data-table">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Clase</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>DescripciÃ³n</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Unidad</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Existencia</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Costo</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  {% for item in inventario_list %}
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.id }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.clase.nombre }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.descripcion }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ item.unidad }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color: {% if item.stock_actual|default:0 <= 0 %}#cc3333{% else %}#339933{% endif %}; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ item.stock_actual|floatformat:2|default:"0.00" }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${{ item.costo_unitario|floatformat:2|default:"0.00" }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  {% empty %}
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="6" style="text-align: center;">No hay elementos en el inventario.</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>

Â  Â  {# --- TABLA DE MOVIMIENTOS --- #}
Â  Â  <div id="view-movimientos" class="data-view" style="display: none;">
Â  Â  Â  Â  <h2>Movimientos Realizados (Entradas y Salidas)</h2>
Â  Â  Â  Â  <table class="data-table">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ID</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Elemento</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Fecha</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Folio Doc.</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>AlmacÃ©n</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Destino/Referencia</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Responsable</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Tipo</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Cantidad</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Precio Uni.</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  {% for mov in movimientos_list %}
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {# âœ… CORRECCIÃ“N: Usar forloop.counter para numeraciÃ³n visual (1, 2, 3...) #}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ forloop.counter }}</td> 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ mov.elemento.descripcion }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ mov.fecha_movimiento|date:"d/m/Y H:i" }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ mov.folio_documento|default_if_none:"" }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {# UbicaciÃ³n del Elemento (AlmacÃ©n) #}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ mov.elemento.ubicacion|default_if_none:"" }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {# Destino/Referencia (Proveedor, proyecto, etc.) #}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>{{ mov.referencia|default_if_none:"" }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {# âœ… CAMBIO CLAVE: Usar el mÃ©todo del modelo para la lÃ³gica de visualizaciÃ³n #}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ mov.get_responsable_display }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {# Tipo de Movimiento #}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% if mov.tipo == 'ENTRADA' %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: green; font-weight: bold;">ENTRADA</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: red; font-weight: bold;">SALIDA</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color: {% if mov.tipo == 'SALIDA' %}#cc3333{% else %}#339933{% endif %}; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{ mov.cantidad|floatformat:2 }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {# Precio unitario #}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${{ mov.precio_unitario|floatformat:2|default:"0.00" }}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  {% empty %}
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td colspan="10" style="text-align: center;">No hay movimientos recientes registrados.</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>

Â  Â  {# --- SCRIPTS DE CONTROL DE PESTAÃ‘AS Y FILTROS --- #}
Â  Â  <script>
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  const STOCK_FILTERS = ['Descripcion', 'Clase'];
Â  Â  Â  Â  Â  Â  const MOV_FILTERS = ['Elemento', 'Destino'];

Â  Â  Â  Â  Â  Â  // FunciÃ³n para alternar los controles de filtro
Â  Â  Â  Â  Â  Â  function updateFilterControls(tabId) {
Â  Â  Â  Â  Â  Â  Â  Â  // Muestra solo los radio buttons relevantes para la pestaÃ±a
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('filter-inventario').style.display = tabId === 'view-stock' ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('filter-movimientos').style.display = tabId === 'view-movimientos' ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // FunciÃ³n para mostrar la pestaÃ±a correcta y actualizar controles/botones
Â  Â  Â  Â  Â  Â  window.showTab = function(tabId) {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Oculta todas las vistas y desactiva botones
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.data-view').forEach(view => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  view.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab-buttons button').forEach(button => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Muestra la vista seleccionada y activa el botÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(tabId).style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tab-' + tabId.split('-')[1]).classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 3. Actualiza los controles de filtro
Â  Â  Â  Â  Â  Â  Â  Â  updateFilterControls(tabId);

Â  Â  Â  Â  Â  Â  Â  Â  // 4. Guarda la pestaÃ±a activa
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('activeTab', tabId);

Â  Â  Â  Â  Â  Â  Â  Â  // 5. Ajustar el radio button por defecto si no hay filtro activo en la URL O si el filtro de la URL
Â  Â  Â  Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  Â  Â  const filtro_por = urlParams.get('filtro_por');
Â  Â  Â  Â  Â  Â  Â  Â  const busqueda = urlParams.get('busqueda');
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  let isFilterInconsistent = false;
Â  Â  Â  Â  Â  Â  Â  Â  if (filtro_por) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isStockFilter = STOCK_FILTERS.includes(filtro_por);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isMovFilter = MOV_FILTERS.includes(filtro_por);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if ((tabId === 'view-stock' && isMovFilter) || (tabId === 'view-movimientos' && isStockFilter)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isFilterInconsistent = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Determinar si necesitamos forzar el radio button por defecto
Â  Â  Â  Â  Â  Â  Â  Â  const needsDefaultRadio = !filtro_por || isFilterInconsistent;
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (needsDefaultRadio && !busqueda) { // Solo si no hay bÃºsqueda activa y el filtro no estÃ¡ bien puesto
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let defaultFilterValue = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tabId === 'view-stock') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  defaultFilterValue = 'Descripcion';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (tabId === 'view-movimientos') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  defaultFilterValue = 'Elemento';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Chequear el radio button por defecto
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (defaultFilterValue) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const defaultRadio = document.querySelector(`input[name="filtro_por"][value="${defaultFilterValue}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (defaultRadio) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  defaultRadio.checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  const busqueda = urlParams.get('busqueda');
Â  Â  Â  Â  Â  Â  const filtro_por = urlParams.get('filtro_por');
Â  Â  Â  Â  Â  Â  const isFiltering = busqueda && busqueda !== '';
Â  Â  Â  Â  Â  Â  let defaultTab = 'view-stock';

Â  Â  Â  Â  Â  Â  // ðŸ”‘ LÃ³gica de inicializaciÃ³n:
Â  Â  Â  Â  Â  Â  if (isFiltering && filtro_por) {
Â  Â  Â  Â  Â  Â  Â  Â  // Si hay bÃºsqueda y filtro, la pestaÃ±a debe coincidir con el filtro usado
Â  Â  Â  Â  Â  Â  Â  Â  if (MOV_FILTERS.includes(filtro_por)) { // Filtros de movimientos
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  defaultTab = 'view-movimientos';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (STOCK_FILTERS.includes(filtro_por)) { // Filtros de inventario
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  defaultTab = 'view-stock';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Si no hay bÃºsqueda, usamos la pestaÃ±a guardada en localStorage, sino 'view-stock'
Â  Â  Â  Â  Â  Â  Â  Â  const storedTab = localStorage.getItem('activeTab');
Â  Â  Â  Â  Â  Â  Â  Â  if (storedTab) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  defaultTab = storedTab;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Inicializa la pestaÃ±a. Esto llama a showTab() que maneja la visibilidad y el estado de los radio buttons.
Â  Â  Â  Â  Â  Â  showTab(defaultTab);
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  // Si hay bÃºsqueda, aseguramos que el radio button correcto (filtrado por Django) se mantenga chequeado.
Â  Â  Â  Â  Â  Â  if(isFiltering && filtro_por) {
Â  Â  Â  Â  Â  Â  Â  Â  const radio = document.querySelector(`input[name="filtro_por"][value="${filtro_por}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if (radio) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radio.checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
{% endblock %}